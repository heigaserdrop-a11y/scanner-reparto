<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>HEIGASER - Esc√°ner</title>

  <!-- Librer√≠a esc√°ner -->
  <script src="https://unpkg.com/html5-qrcode"></script>
</head>

<body style="font-family: Arial; text-align: center; padding: 20px;">

  <h1>HEIGASER</h1>
  <h2>Escanear Gu√≠a</h2>

  <div id="reader" style="width:100%; max-width:400px; margin:auto;"></div>

  <p id="guia" style="font-size:18px; font-weight:bold;"></p>
  <p id="datos" style="font-size:16px;"></p>

  <div id="mensaje" style="
    display:none;
    margin-top:15px;
    padding:15px;
    border-radius:10px;
    font-size:18px;
    font-weight:bold;
  "></div>

  <button onclick="marcar('ENTREGADO')" style="padding:15px; margin:10px; width:90%;">
    ‚úÖ ENTREGADO
  </button>

  <button onclick="marcar('REINTENTO')" style="padding:15px; margin:10px; width:90%;">
    üîÅ REINTENTO
  </button>

<script>
  let guiaActual = "";
  let datosGuia = null;

  // ESC√ÅNER
  const html5QrCode = new Html5Qrcode("reader");

  Html5Qrcode.getCameras().then(cameras => {
    const camaraTrasera = cameras[cameras.length - 1].id;
    html5QrCode.start(
      camaraTrasera,
      { fps: 10, qrbox: 250 },
      texto => buscarGuia(texto)
    );
  });

  async function buscarGuia(guia) {
    await cargarSupabase();

    const supabase = window.supabase.createClient(
      "https://dqjnarpnszgmsvmbebzk.supabase.co",
      "sb_publishable_C-alQtgPteApYrtwzm9QiQ_xHLw9VxA"
    );

    const { data, error } = await supabase
      .from("pedidos")
      .select("*")
      .eq("guia", guia)
      .single();

    if (error || !data) {
      mostrarMensaje("‚ùå Gu√≠a no encontrada en la base de datos", "warn");
      return;
    }

    guiaActual = guia;
    datosGuia = data;

    document.getElementById("guia").innerText =
      "Gu√≠a: " + data.guia;

    document.getElementById("datos").innerText =
      "Cliente: " + data.nombre + " | Recaudo: $" + data.recaudo.toLocaleString();
  }

  async function marcar(estado) {
    if (!guiaActual || !datosGuia) {
      mostrarMensaje("‚ö†Ô∏è Escanea una gu√≠a v√°lida", "warn");
      return;
    }

    if (datosGuia.estado === "ENTREGADO") {
      mostrarMensaje("üö´ Este pedido ya fue entregado", "warn");
      return;
    }

    await cargarSupabase();

    const supabase = window.supabase.createClient(
      "https://dqjnarpnszgmsvmbebzk.supabase.co",
      "sb_publishable_C-alQtgPteApYrtwzm9QiQ_xHLw9VxA"
    );

    const { error } = await supabase
      .from("entregas")
      .update({ estado })
      .eq("guia", guiaActual);

    if (error) {
      mostrarMensaje("‚ùå Error al actualizar", "warn");
      return;
    }

    mostrarMensaje(
      estado === "ENTREGADO"
        ? "‚úÖ Pedido entregado correctamente"
        : "üîÅ Pedido marcado como reintento",
      "ok"
    );

    guiaActual = "";
    datosGuia = null;
    document.getElementById("guia").innerText = "";
    document.getElementById("datos").innerText = "";
  }

  function cargarSupabase() {
    return new Promise(resolve => {
      if (window.supabase) return resolve();
      const s = document.createElement("script");
      s.src = "https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2";
      s.onload = resolve;
      document.body.appendChild(s);
    });
  }

  function mostrarMensaje(texto, tipo) {
    const m = document.getElementById("mensaje");
    m.innerText = texto;
    m.style.display = "block";
    m.style.background = tipo === "ok" ? "#e6f9ee" : "#fff3cd";
    m.style.border = "2px solid";
    setTimeout(() => m.style.display = "none", 3000);
  }
</script>

</body>
</html>

