<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>HEIGASER - Esc√°ner</title>
<script src="https://unpkg.com/html5-qrcode"></script>

<style>
body{
  font-family:Arial;
  text-align:center;
  padding:15px;
}

/* ===== SLIDE BUTTON ===== */
.slide-btn{
  position:relative;
  width:100%;
  height:54px;
  border-radius:30px;
  margin:12px 0;
  overflow:hidden;
  user-select:none;
}

.slide-track{
  position:absolute;
  inset:0;
  display:flex;
  align-items:center;
  justify-content:center;
  font-weight:bold;
  color:white;
}

.slide-handle{
  position:absolute;
  top:4px;
  width:46px;
  height:46px;
  border-radius:50%;
  background:white;
  box-shadow:0 2px 6px rgba(0,0,0,.35);
  display:flex;
  align-items:center;
  justify-content:center;
  font-size:22px;
  z-index:2;
  transition:left .25s ease;
}

.entregado{background:#2ecc71;}
.reintento{background:#f39c12;}
</style>
</head>

<body>

<h1>HEIGASER</h1>
<h3>Escanear Gu√≠a</h3>

<div style="position:relative;max-width:360px;margin:auto">
  <div id="reader" style="width:100%;height:220px;border-radius:12px;overflow:hidden"></div>

  <div id="overlay" style="
    display:none;
    position:absolute;
    inset:0;
    background:rgba(0,0,0,.85);
    color:white;
    font-size:20px;
    font-weight:bold;
    border-radius:12px;
    align-items:center;
    justify-content:center;
    z-index:5;
    text-align:center;
    padding:15px;">
  </div>
</div>

<div id="info" style="margin-top:15px;font-size:16px;font-weight:bold"></div>

<!-- ===== SLIDE ENTREGADO ===== -->
<div class="slide-btn entregado" id="slideEntregado">
  <div class="slide-track">DESLIZA PARA ENTREGAR</div>
  <div class="slide-handle" style="left:4px">‚úÖ</div>
</div>

<!-- ===== SLIDE REINTENTO ===== -->
<div class="slide-btn reintento" id="slideReintento">
  <div class="slide-track">DESLIZA PARA REINTENTO</div>
  <div class="slide-handle" style="left:4px">üîÅ</div>
</div>

<audio id="sonidoOk" src="https://actions.google.com/sounds/v1/cartoon/positive_ding.ogg"></audio>
<audio id="sonidoWarn" src="https://actions.google.com/sounds/v1/cartoon/wood_plank_flicks.ogg"></audio>
<audio id="sonidoError" src="https://actions.google.com/sounds/v1/cartoon/clang_and_wobble.ogg"></audio>

<script>
let guiaActual="";
const URL="https://script.google.com/macros/s/AKfycbxRG-nLiNbXXzZMOBTd9Xqf5Ve1XLFKq5V2aOSkQEj48_cTiTciP_TMKgjW6-tOrBXxQw/exec";

/* ===== ESC√ÅNER ===== */
const html5QrCode=new Html5Qrcode("reader");
Html5Qrcode.getCameras().then(c=>{
  html5QrCode.start(c[c.length-1].id,{fps:10,qrbox:180},t=>buscarGuia(t));
});

/* ===== BUSCAR GU√çA ===== */
async function buscarGuia(guia){
  guiaActual=guia;
  mostrar("üîç BUSCANDO PEDIDO...");
  try{
    const r=await fetch(`${URL}?guia=${encodeURIComponent(guia)}`);
    const d=await r.json();
    ocultar();

    if(!d.encontrado){
      mostrarResultado("‚ùå GU√çA NO EXISTE","error"); sonar("error"); guiaActual=""; return;
    }
    if(d.estado==="ENTREGADO"){
      mostrarResultado("üö´ ESTA GU√çA YA FUE ENTREGADA","warn"); sonar("warn"); guiaActual=""; return;
    }

    info.innerHTML=`üì¶ ${guia}<br>üë§ ${d.nombre||"SIN NOMBRE"}<br>üí∞ $${Number(d.valor||0).toLocaleString()}`;
    sonar("ok");
  }catch{
    ocultar();
    mostrarResultado("‚ùå ERROR DE CONEXI√ìN","error"); sonar("error"); guiaActual="";
  }
}

/* ===== MARCAR ===== */
async function marcar(estado){
  if(!guiaActual){mostrarResultado("‚ö†Ô∏è ESCANEA UNA GU√çA","warn"); sonar("warn"); return;}
  mostrar("‚è≥ PROCESANDO...");
  try{
    const r=await fetch(URL,{
      method:"POST",
      headers:{"Content-Type":"application/x-www-form-urlencoded"},
      body:`guia=${encodeURIComponent(guiaActual)}&estado=${estado}`
    });
    const t=await r.text(); ocultar();

    if(t==="ENTREGADO"){
      mostrarResultado("üö´ ESTA GU√çA YA FUE ENTREGADA","warn"); sonar("warn");
    }else if(estado==="ENTREGADO"){
      mostrarResultado("‚úÖ PEDIDO ENTREGADO","ok"); sonar("ok");
    }else{
      mostrarResultado("üîÅ PEDIDO MARCADO PARA REINTENTO","warn"); sonar("warn");
    }

    guiaActual=""; info.innerHTML="";
    resetSliders();
  }catch{
    ocultar();
    mostrarResultado("‚ùå ERROR DE CONEXI√ìN","error"); sonar("error");
  }
}

/* ===== OVERLAY ===== */
function mostrar(t){overlay.innerText=t;overlay.style.display="flex";}
function ocultar(){overlay.style.display="none";}
function mostrarResultado(t,tipo){
  overlay.innerText=t;
  overlay.style.background=tipo==="ok"?"rgba(0,120,60,.85)":tipo==="warn"?"rgba(180,120,0,.85)":"rgba(160,0,0,.85)";
  overlay.style.display="flex";
  setTimeout(()=>overlay.style.display="none",1800);
}
function sonar(tipo){
  if(navigator.vibrate)navigator.vibrate(200);
  (tipo==="ok"?sonidoOk:tipo==="warn"?sonidoWarn:sonidoError).currentTime=0;
  (tipo==="ok"?sonidoOk:tipo==="warn"?sonidoWarn:sonidoError).play();
}

/* ===== SLIDE REAL ===== */
function slideReal(btn,estado){
  const handle=btn.querySelector(".slide-handle");
  const max=btn.offsetWidth-handle.offsetWidth-6;
  let startX=0, current=0, dragging=false;

  handle.addEventListener("touchstart",e=>{
    startX=e.touches[0].clientX;
    dragging=true;
    handle.style.transition="none";
  });

  handle.addEventListener("touchmove",e=>{
    if(!dragging)return;
    current=e.touches[0].clientX-startX;
    current=Math.max(0,Math.min(current,max));
    handle.style.left=current+"px";
  });

  handle.addEventListener("touchend",()=>{
    dragging=false;
    handle.style.transition="left .25s ease";
    if(current>max*0.8){
      handle.style.left=max+"px";
      setTimeout(()=>marcar(estado),150);
    }else{
      handle.style.left="4px";
    }
  });
}

function resetSliders(){
  document.querySelectorAll(".slide-handle").forEach(h=>{
    h.style.transition="left .25s ease";
    h.style.left="4px";
  });
}

slideReal(slideEntregado,"ENTREGADO");
slideReal(slideReintento,"REINTENTO");
</script>

</body>
</html>
