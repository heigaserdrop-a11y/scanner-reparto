<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>HEIGASER - Esc√°ner</title>
<script src="https://unpkg.com/html5-qrcode"></script>

<style>
body{
  font-family:Arial;
  text-align:center;
  background:#f4f6f8;
  margin:0;
}

/* HEADER */
.header{
  background:linear-gradient(135deg,#0f3d2e,#1e8e5a);
  color:white;
  padding:22px 10px 18px;
  border-radius:0 0 25px 25px;
  box-shadow:0 4px 15px rgba(0,0,0,.2);
}
.logo{font-size:34px;font-weight:bold;letter-spacing:2px;}
.subempresa{font-size:15px;margin-top:4px;color:#9cffc7;font-weight:bold;}

/* CARD */
.card{
  background:white;
  border-radius:16px;
  box-shadow:0 4px 14px rgba(0,0,0,.12);
  padding:12px;
  margin:15px auto;
  max-width:360px;
}

/* ESC√ÅNER */
#reader{height:220px;border-radius:14px;overflow:hidden;}

/* OVERLAY */
#overlay{
  display:none;
  position:absolute;
  inset:0;
  background:rgba(0,0,0,.85);
  color:white;
  font-size:18px;
  align-items:center;
  justify-content:center;
  border-radius:14px;
  z-index:5;
}

/* SLIDERS */
.slide-btn{
  position:relative;
  height:54px;
  border-radius:30px;
  margin:12px auto;
  max-width:360px;
  overflow:hidden;
  color:white;
}
.slide-track{
  position:absolute;
  inset:0;
  display:flex;
  align-items:center;
  justify-content:center;
  font-weight:bold;
}
.slide-handle{
  position:absolute;
  top:4px;
  left:4px;
  width:46px;
  height:46px;
  border-radius:50%;
  background:white;
  display:flex;
  align-items:center;
  justify-content:center;
  font-size:22px;
  box-shadow:0 2px 6px rgba(0,0,0,.3);
  transition:left .25s ease;
}

.entregado{background:#2ecc71;}
.reintento{background:#f39c12;}
.devolucion{background:#e74c3c;}

/* SELLO */
#selloEntregado{
  position:fixed;
  inset:0;
  display:none;
  align-items:center;
  justify-content:center;
  z-index:9999;
  pointer-events:none;
}
.sello{
  border:6px solid #2ecc71;
  color:#2ecc71;
  font-size:42px;
  font-weight:900;
  padding:22px 40px;
  border-radius:14px;
  background:rgba(255,255,255,.95);
  box-shadow:0 10px 30px rgba(0,0,0,.25);
  transform:scale(0) rotate(-20deg);
  animation:selloPop 1.1s ease forwards;
}
@keyframes selloPop{
  0%{transform:scale(0) rotate(-20deg);opacity:0}
  60%{transform:scale(1.2) rotate(5deg);opacity:1}
  100%{transform:scale(1) rotate(0)}
}
</style>
</head>

<body>

<div class="header">
  <div class="logo">HEIGASER</div>
  <div class="subempresa">Operado por ENV√çOS GW</div>
</div>

<div class="card" style="position:relative">
  <div id="reader"></div>
  <div id="overlay"></div>
</div>

<div id="info" class="card" style="font-weight:bold"></div>

<div class="slide-btn entregado" id="btnEntregado">
  <div class="slide-track">Desliza para entregar</div>
  <div class="slide-handle">‚úÖ</div>
</div>

<div class="slide-btn reintento" id="btnReintento">
  <div class="slide-track">Desliza para reintento</div>
  <div class="slide-handle">üîÅ</div>
</div>

<div class="slide-btn devolucion" id="btnDevolucion">
  <div class="slide-track">Desliza para DEVOLUCI√ìN</div>
  <div class="slide-handle">‚Ü©Ô∏è</div>
</div>

<div id="selloEntregado">
  <div class="sello">ENTREGADO</div>
</div>

<audio id="sonidoOk" src="https://actions.google.com/sounds/v1/cartoon/positive_ding.ogg"></audio>
<audio id="sonidoWarn" src="https://actions.google.com/sounds/v1/cartoon/wood_plank_flicks.ogg"></audio>
<audio id="sonidoError" src="https://actions.google.com/sounds/v1/cartoon/clang_and_wobble.ogg"></audio>

<script>
let guiaActual="";
let audioListo=false;

const URL="https://script.google.com/macros/s/AKfycbxRG-nLiNbXXzZMOBTd9Xqf5Ve1XLFKq5V2aOSkQEj48_cTiTciP_TMKgjW6-tOrBXxQw/exec";

/* AUDIO */
function desbloquearAudio(){
  if(audioListo) return;
  sonidoOk.play().then(()=>{
    sonidoOk.pause(); sonidoOk.currentTime=0; audioListo=true;
  }).catch(()=>{});
}
document.addEventListener("touchstart",desbloquearAudio,{once:true});
document.addEventListener("click",desbloquearAudio,{once:true});

/* ESC√ÅNER */
const qr=new Html5Qrcode("reader");
Html5Qrcode.getCameras().then(c=>{
  qr.start(c[c.length-1].id,{fps:10,qrbox:180},t=>buscar(t));
});

/* BUSCAR */
async function buscar(g){
  guiaActual=g;
  mostrar("üîç BUSCANDO...");
  try{
    const r=await fetch(`${URL}?guia=${encodeURIComponent(g)}`);
    const d=await r.json();
    ocultar();

    if(!d.encontrado){
      resultado("‚ùå NO EXISTE","error"); sonar("error"); guiaActual=""; return;
    }
    if(d.estado==="ENTREGADO"){
      resultado("üö´ YA ENTREGADO","warn"); sonar("warn"); guiaActual=""; return;
    }

    info.innerHTML=`üì¶ ${g}<br>üë§ ${d.nombre||"SIN NOMBRE"}<br>üí∞ $${Number(d.valor||0).toLocaleString()}`;
    sonar("ok");

  }catch{
    ocultar(); resultado("‚ùå ERROR","error"); sonar("error");
  }
}

/* ENVIAR */
async function enviar(estado){

  if(!guiaActual){
    resultado("‚ö†Ô∏è ESCANEA UNA GU√çA","warn"); sonar("warn"); return;
  }

  if(estado==="DEVOLUCION"){
    if(!confirm("¬øCONFIRMAS DEVOLUCI√ìN DEL PEDIDO?")) return;
  }

  mostrar("‚è≥ PROCESANDO...");
  try{
    await fetch(URL,{
      method:"POST",
      headers:{"Content-Type":"application/x-www-form-urlencoded"},
      body:`guia=${encodeURIComponent(guiaActual)}&estado=${estado}`
    });

    ocultar();

    if(estado==="ENTREGADO"){
      mostrarSelloEntregado(); resultado("‚úÖ ENTREGADO","ok"); sonar("ok");
    }
    else if(estado==="DEVOLUCION"){
      resultado("‚Ü©Ô∏è EN DEVOLUCI√ìN","warn"); sonar("warn");
    }
    else{
      resultado("üîÅ REINTENTO","warn"); sonar("warn");
    }

    guiaActual=""; info.innerHTML="";

  }catch{
    ocultar(); resultado("‚ùå ERROR","error"); sonar("error");
  }
}

/* SLIDERS */
function slider(el,estado){
  let startX;
  const h=el.querySelector(".slide-handle");
  el.addEventListener("touchstart",e=>startX=e.touches[0].clientX);
  el.addEventListener("touchmove",e=>{
    let dx=e.touches[0].clientX-startX;
    dx=Math.max(4,Math.min(260,dx));
    h.style.left=dx+"px";
  });
  el.addEventListener("touchend",()=>{
    if(h.offsetLeft>200) enviar(estado);
    setTimeout(()=>h.style.left="4px",200);
  });
}

slider(btnEntregado,"ENTREGADO");
slider(btnReintento,"REINTENTO");
slider(btnDevolucion,"DEVOLUCION");

/* UI */
function mostrar(t){overlay.innerText=t;overlay.style.display="flex";}
function ocultar(){overlay.style.display="none";}
function resultado(t,tipo){
  overlay.innerText=t;
  overlay.style.background=
    tipo==="ok"?"rgba(0,120,60,.85)":
    tipo==="warn"?"rgba(180,120,0,.85)":"rgba(160,0,0,.85)";
  overlay.style.display="flex";
  setTimeout(()=>overlay.style.display="none",1800);
}
function sonar(tipo){
  if(navigator.vibrate) navigator.vibrate(200);
  let a=tipo==="ok"?sonidoOk:tipo==="warn"?sonidoWarn:sonidoError;
  a.currentTime=0; a.play();
}
function mostrarSelloEntregado(){
  selloEntregado.style.display="flex";
  setTimeout(()=>selloEntregado.style.display="none",1200);
}
</script>

</body>
</html>
