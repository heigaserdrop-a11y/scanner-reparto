<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>HEIGASER - EscÃ¡ner</title>
<script src="https://unpkg.com/html5-qrcode"></script>

<style>
.slide-btn {
  position: relative;
  width: 100%;
  height: 52px;
  border-radius: 30px;
  margin: 12px 0;
  overflow: hidden;
}
.slide-track {
  position:absolute;
  inset:0;
  display:flex;
  align-items:center;
  justify-content:center;
  font-weight:bold;
}
.slide-handle {
  position:absolute;
  top:3px;
  left:3px;
  width:46px;
  height:46px;
  border-radius:50%;
  background:#fff;
  display:flex;
  align-items:center;
  justify-content:center;
  font-size:22px;
  box-shadow:0 2px 6px rgba(0,0,0,.3);
  transition:left .2s;
}
.entregado { background:#2ecc71; color:#fff; }
.reintento { background:#f39c12; color:#fff; }
</style>
</head>

<body style="font-family:Arial;text-align:center;padding:15px">

<h2>HEIGASER</h2>

<div style="max-width:360px;margin:auto;position:relative">
  <div id="reader" style="height:220px;border-radius:12px;overflow:hidden"></div>
  <div id="overlay" style="display:none;position:absolute;inset:0;
    background:rgba(0,0,0,.85);color:white;font-size:18px;
    align-items:center;justify-content:center;border-radius:12px"></div>
</div>

<div id="info" style="margin-top:12px;font-weight:bold"></div>

<input type="file" id="foto" accept="image/*" capture="environment" style="margin:10px 0;width:100%">

<div class="slide-btn entregado" id="btnEntregado">
  <div class="slide-track">DESLIZA PARA ENTREGAR</div>
  <div class="slide-handle">âœ…</div>
</div>

<div class="slide-btn reintento" id="btnReintento">
  <div class="slide-track">DESLIZA PARA REINTENTO</div>
  <div class="slide-handle">ğŸ”</div>
</div>

<script>
let guiaActual="";
let imagenBase64="";
const URL="https://script.google.com/macros/s/AKfycbxuxWqOPnUAvNX-sirgTP3gZ8F-Q_PkEQVcRs3Q9j2lzvOqCWyJ3rQ8u2da6avwKSxPzQ/exec";

// FOTO
foto.onchange=()=>{
  const reader=new FileReader();
  reader.onload=()=>imagenBase64=reader.result;
  reader.readAsDataURL(foto.files[0]);
};

// ESCÃNER
const qr=new Html5Qrcode("reader");
Html5Qrcode.getCameras().then(c=>{
  qr.start(c[c.length-1].id,{fps:10,qrbox:180},t=>buscar(t));
});

async function buscar(g){
  guiaActual=g;
  mostrar("ğŸ” BUSCANDO...");
  const r=await fetch(`${URL}?guia=${g}`);
  const d=await r.json();
  ocultar();
  if(!d.encontrado){mensaje("âŒ NO EXISTE");return;}
  if(d.estado==="ENTREGADO"){mensaje("ğŸš« YA ENTREGADO");guiaActual="";return;}
  info.innerHTML=`ğŸ“¦ ${g}<br>ğŸ‘¤ ${d.nombre}<br>ğŸ’° $${Number(d.valor).toLocaleString()}`;
}

async function enviar(estado){
  if(!guiaActual){mensaje("âš ï¸ ESCANEA");return;}
  if(estado==="ENTREGADO" && !imagenBase64){mensaje("ğŸ“¸ FOTO OBLIGATORIA");return;}

  mostrar("â³ PROCESANDO...");
  const r=await fetch(URL,{
    method:"POST",
    headers:{"Content-Type":"application/x-www-form-urlencoded"},
    body:`guia=${guiaActual}&estado=${estado}&imagen=${encodeURIComponent(imagenBase64)}`
  });
  const t=await r.text();
  ocultar();

  if(t==="ENTREGADO") mensaje("ğŸš« YA ENTREGADO");
  else if(t==="ACTUALIZADO") mensaje("âœ… ENTREGADO");
  else if(t==="REINTENTO") mensaje("ğŸ” REINTENTO");
  else mensaje("âŒ ERROR");

  guiaActual=""; imagenBase64=""; info.innerHTML=""; foto.value="";
}

function slider(el,estado){
  let startX;
  const h=el.querySelector(".slide-handle");
  el.addEventListener("touchstart",e=>startX=e.touches[0].clientX);
  el.addEventListener("touchmove",e=>{
    const dx=e.touches[0].clientX-startX;
    h.style.left=Math.min(260,Math.max(3,dx))+"px";
  });
  el.addEventListener("touchend",e=>{
    if(h.offsetLeft>200) enviar(estado);
    h.style.left="3px";
  });
}

slider(btnEntregado,"ENTREGADO");
slider(btnReintento,"REINTENTO");

function mostrar(t){overlay.innerText=t;overlay.style.display="flex";}
function ocultar(){overlay.style.display="none";}
function mensaje(t){mostrar(t);setTimeout(ocultar,1500);}
</script>

</body>
</html>
