<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>HEIGASER - Esc√°ner</title>

<script src="https://unpkg.com/html5-qrcode"></script>

<style>
  body {
    font-family: Arial;
    text-align: center;
    padding: 20px;
  }

  #scanner-box {
    position: relative;
    width: 100%;
    max-width: 360px;
    height: 260px;
    margin: auto;
    border-radius: 12px;
    overflow: hidden;
  }

  #reader {
    width: 100%;
    height: 100%;
  }

  #overlay {
    display: none;
    position: absolute;
    inset: 0;
    background: rgba(0,0,0,0.85);
    color: white;
    font-size: 22px;
    font-weight: bold;
    align-items: center;
    justify-content: center;
    text-align: center;
    padding: 20px;
    z-index: 10;
  }

  button {
    padding: 15px;
    margin: 10px;
    width: 90%;
    font-size: 18px;
  }
</style>
</head>

<body>

<h1>HEIGASER</h1>
<h2>Escanear Gu√≠a</h2>

<div id="scanner-box">
  <div id="reader"></div>
  <div id="overlay"></div>
</div>

<p id="guia" style="font-size:18px; font-weight:bold; margin-top:15px;"></p>

<button onclick="marcar('ENTREGADO')">‚úÖ ENTREGADO</button>
<button onclick="marcar('REINTENTO')">üîÅ REINTENTO</button>

<!-- SONIDOS -->
<audio id="ok" src="https://actions.google.com/sounds/v1/cartoon/positive_ding.ogg"></audio>
<audio id="warn" src="https://actions.google.com/sounds/v1/cartoon/wood_plank_flicks.ogg"></audio>
<audio id="error" src="https://actions.google.com/sounds/v1/cartoon/clang_and_wobble.ogg"></audio>

<script>
let guiaActual = "";

// ===== ESC√ÅNER =====
const scanner = new Html5Qrcode("reader");

Html5Qrcode.getCameras().then(cameras => {
  scanner.start(
    cameras[cameras.length - 1].id,
    { fps: 10, qrbox: 200 },
    text => {
      guiaActual = text;
      document.getElementById("guia").innerText = "Gu√≠a: " + text;

      // üì≥ vibraci√≥n al escanear
      vibrar([100]);
    }
  );
});

// ===== BOTONES =====
async function marcar(estado) {
  if (!guiaActual) {
    mostrar("‚ö†Ô∏è ESCANEA UNA GU√çA", "warn");
    return;
  }

  mostrar("‚è≥ PROCESANDO...", null);

  try {
    const res = await fetch(
      "https://script.google.com/macros/s/AKfycbzzByEqoXxN9SLz0O_8hmbU2W9MTqWu6t6qnKaT_FAiYzGsBThKt4P-VElvzzh-yckZ2A/exec",
      {
        method: "POST",
        headers: {"Content-Type":"application/x-www-form-urlencoded"},
        body: `guia=${encodeURIComponent(guiaActual)}&estado=${estado}`
      }
    );

    const txt = await res.text();

    if (txt === "DUPLICADO") {
      mostrar("üö´ GU√çA YA REGISTRADA", "warn");
      vibrar([200,100,200]);
    } 
    else if (txt === "GUARDADO") {
      mostrar(
        estado === "ENTREGADO"
          ? "‚úÖ PEDIDO ENTREGADO"
          : "üîÅ REINTENTO REGISTRADO",
        "ok"
      );
      vibrar([300]);
    } 
    else {
      mostrar("‚ùå ERROR", "error");
      vibrar([400,150,400]);
    }

    guiaActual = "";
    document.getElementById("guia").innerText = "";

  } catch {
    mostrar("‚ùå ERROR DE CONEXI√ìN", "error");
    vibrar([400,150,400]);
  }
}

// ===== OVERLAY + SONIDO =====
function mostrar(texto, tipo) {
  const o = document.getElementById("overlay");
  o.innerText = texto;
  o.style.display = "flex";

  if (tipo === "ok") document.getElementById("ok").play();
  if (tipo === "warn") document.getElementById("warn").play();
  if (tipo === "error") document.getElementById("error").play();

  if (tipo) {
    setTimeout(() => o.style.display = "none", 2000);
  }
}

// ===== VIBRACI√ìN =====
function vibrar(patron) {
  if (navigator.vibrate) {
    navigator.vibrate(patron);
  }
}
</script>

</body>
</html>
