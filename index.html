<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>HEIGASER - Esc√°ner</title>
<script src="https://unpkg.com/html5-qrcode"></script>

<style>
body{
  font-family:Arial;
  background:#f4f6f8;
  margin:0;
  text-align:center;
}

/* HEADER */
.header{
  background:linear-gradient(135deg,#0f3d2e,#1e8e5a);
  color:white;
  padding:24px 10px 20px;
  border-radius:0 0 26px 26px;
  box-shadow:0 4px 18px rgba(0,0,0,.25);
}
.logo{
  font-size:36px;
  font-weight:800;
  letter-spacing:2px;
}
.subempresa{
  margin-top:6px;
  font-size:15px;
  color:#9cffc7;
  font-weight:bold;
}

/* CARD */
.card{
  background:white;
  border-radius:16px;
  box-shadow:0 4px 14px rgba(0,0,0,.12);
  padding:12px;
  margin:15px auto;
  max-width:360px;
}

/* SCANNER */
#reader{
  height:220px;
  border-radius:14px;
  overflow:hidden;
}
.scan-success{
  animation:flashGreen .6s ease;
}
@keyframes flashGreen{
  0%{box-shadow:0 0 0 rgba(46,204,113,0)}
  50%{box-shadow:0 0 26px rgba(46,204,113,.9)}
  100%{box-shadow:0 0 0 rgba(46,204,113,0)}
}

/* OVERLAY */
#overlay{
  display:none;
  position:absolute;
  inset:0;
  background:rgba(0,0,0,.85);
  color:white;
  font-size:18px;
  align-items:center;
  justify-content:center;
  border-radius:14px;
  z-index:5;
}

/* SLIDER */
.slide-btn{
  position:relative;
  height:54px;
  border-radius:30px;
  margin:12px auto;
  max-width:360px;
  overflow:hidden;
  color:white;
}
.slide-track{
  position:absolute;
  inset:0;
  display:flex;
  align-items:center;
  justify-content:center;
  font-weight:bold;
}
.slide-handle{
  position:absolute;
  top:4px;
  left:4px;
  width:46px;
  height:46px;
  border-radius:50%;
  background:white;
  display:flex;
  align-items:center;
  justify-content:center;
  font-size:22px;
  box-shadow:0 2px 6px rgba(0,0,0,.3);
  transition:left .35s cubic-bezier(.25,1.4,.5,1);
}
.slide-handle.dragging{
  transition:none;
  transform:scale(1.1);
}

.entregado{background:#2ecc71}
.reintento{background:#f39c12}

/* TOAST */
#toast{
  position:fixed;
  bottom:-80px;
  left:50%;
  transform:translateX(-50%);
  padding:14px 22px;
  background:#2ecc71;
  color:white;
  font-weight:bold;
  border-radius:14px;
  box-shadow:0 6px 20px rgba(0,0,0,.25);
  transition:bottom .4s ease;
  z-index:999;
}
#toast.show{bottom:30px}
</style>
</head>

<body>

<div class="header">
  <div class="logo">HEIGASER</div>
  <div class="subempresa">Operado por ENV√çOS GW</div>
</div>

<div class="card" style="position:relative">
  <div id="reader"></div>
  <div id="overlay"></div>
</div>

<div id="info" class="card" style="font-weight:bold"></div>

<div class="slide-btn entregado" id="btnEntregado">
  <div class="slide-track">Desliza para confirmar entrega</div>
  <div class="slide-handle">‚úÖ</div>
</div>

<div class="slide-btn reintento" id="btnReintento">
  <div class="slide-track">Desliza para marcar reintento</div>
  <div class="slide-handle">üîÅ</div>
</div>

<div id="toast"></div>

<audio id="soundScan" src="https://assets.mixkit.co/active_storage/sfx/2869/2869-preview.mp3"></audio>
<audio id="soundOk" src="https://assets.mixkit.co/active_storage/sfx/1435/1435-preview.mp3"></audio>
<audio id="soundWarn" src="https://actions.google.com/sounds/v1/cartoon/wood_plank_flicks.ogg"></audio>
<audio id="soundError" src="https://actions.google.com/sounds/v1/cartoon/clang_and_wobble.ogg"></audio>

<script>
let guiaActual="";
const URL="https://script.google.com/macros/s/AKfycbxRG-nLiNbXXzZMOBTd9Xqf5Ve1XLFKq5V2aOSkQEj48_cTiTciP_TMKgjW6-tOrBXxQw/exec";

/* SCAN */
const qr=new Html5Qrcode("reader");
Html5Qrcode.getCameras().then(c=>{
  qr.start(c[c.length-1].id,{fps:10,qrbox:180},t=>{
    reader.classList.add("scan-success");
    soundScan.play();
    navigator.vibrate?.(120);
    setTimeout(()=>reader.classList.remove("scan-success"),600);
    buscar(t);
  });
});

/* BUSCAR */
async function buscar(g){
  guiaActual=g;
  mostrar("üîç BUSCANDO...");
  try{
    const r=await fetch(`${URL}?guia=${encodeURIComponent(g)}`);
    const d=await r.json();
    ocultar();

    if(!d.encontrado){toast("‚ùå GU√çA NO EXISTE",false);guiaActual="";return;}
    if(d.estado==="ENTREGADO"){toast("üö´ YA ENTREGADO",false);guiaActual="";return;}

    info.innerHTML=`üì¶ ${g}<br>üë§ ${d.nombre||"SIN NOMBRE"}<br>üí∞ $${Number(d.valor||0).toLocaleString()}`;
  }catch{
    ocultar();
    toast("‚ùå ERROR DE CONEXI√ìN",false);
    guiaActual="";
  }
}

/* ENVIAR */
async function enviar(estado){
  if(!guiaActual){toast("‚ö†Ô∏è ESCANEA UNA GU√çA",false);return;}
  mostrar("‚è≥ PROCESANDO...");
  try{
    const r=await fetch(URL,{
      method:"POST",
      headers:{"Content-Type":"application/x-www-form-urlencoded"},
      body:`guia=${encodeURIComponent(guiaActual)}&estado=${estado}`
    });
    const t=await r.text();
    ocultar();

    if(t==="ENTREGADO") toast("üö´ YA ENTREGADO",false);
    else if(estado==="ENTREGADO"){toast("‚úî ENTREGADO"); soundOk.play();}
    else toast("üîÅ REINTENTO",false);

    guiaActual="";
    info.innerHTML="";
  }catch{
    ocultar();
    toast("‚ùå ERROR DE CONEXI√ìN",false);
  }
}

/* SLIDER (AUTO-RESET) */
function slider(el,estado){
  const h=el.querySelector(".slide-handle");
  let startX=0,drag=false;
  const max=el.offsetWidth-h.offsetWidth-6;

  h.addEventListener("touchstart",e=>{
    drag=true;
    startX=e.touches[0].clientX-h.offsetLeft;
    h.classList.add("dragging");
  });

  h.addEventListener("touchmove",e=>{
    if(!drag) return;
    let x=e.touches[0].clientX-startX;
    x=Math.max(4,Math.min(max,x));
    h.style.left=x+"px";
  });

  h.addEventListener("touchend",()=>{
    drag=false;
    h.classList.remove("dragging");

    if(h.offsetLeft>max*0.75){
      h.style.left=max+"px";
      setTimeout(()=>enviar(estado),120);
    }

    /* üîÅ SIEMPRE REGRESA AL INICIO */
    setTimeout(()=>{
      h.style.left="4px";
    },350);
  });
}

slider(btnEntregado,"ENTREGADO");
slider(btnReintento,"REINTENTO");

/* UI */
function mostrar(t){overlay.innerText=t;overlay.style.display="flex";}
function ocultar(){overlay.style.display="none";}
function toast(msg,ok=true){
  toastEl.innerText=msg;
  toastEl.style.background=ok?"#2ecc71":"#f39c12";
  toastEl.classList.add("show");
  setTimeout(()=>toastEl.classList.remove("show"),1500);
}
const toastEl=document.getElementById("toast");
</script>

</body>
</html>
